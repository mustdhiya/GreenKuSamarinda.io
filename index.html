<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenKu - Pengelolaan Sampah Digital</title>
    <link rel="icon" type="image/x-icon" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        /* Fix map container responsive issues */
        #map {
            height: 100% !important;
            width: 100% !important;
            min-height: 400px;
            position: relative !important;
            z-index: 1 !important;
        }

        /* Ensure map container has proper dimensions on mobile */
        @media (max-width: 768px) {
            #map {
                height: calc(100vh - 200px) !important;
                /* Account for bottom panel */
                min-height: 300px !important;
            }

            /* Fix map parent container */
            .flex-grow {
                height: calc(100vh - 120px) !important;
            }

            /* Ensure map doesn't get hidden by bottom panel */
            .flex-grow .h-full {
                padding-bottom: 120px;
                /* Height of collapsed bottom panel */
            }

            header .flex {
                flex-wrap: wrap !important;
            }

            /* Mode buttons container */
            .flex.justify-center.items-center.space-x-4 {
                order: 3;
                width: 100%;
                margin-top: 10px;
                justify-content: center !important;
            }

            /* Mode buttons styling */
            #userModeBtn,
            #staffModeBtn {
                min-height: 44px !important;
                /* Minimum touch target size */
                min-width: 44px !important;
                padding: 8px 16px !important;
                font-size: 14px !important;
                touch-action: manipulation !important;
                -webkit-tap-highlight-color: transparent !important;
            }

            /* Ensure buttons are above other elements */
            header {
                z-index: 1001 !important;
                position: relative !important;
            }
        }

        /* Force map tiles to load properly */
        .leaflet-container {
            height: 100% !important;
            width: 100% !important;
        }

        /* Fix any overflow issues */
        .leaflet-control-container {
            z-index: 1000 !important;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
        }

        .custom-popup .leaflet-popup-content {
            margin: 0;
            width: 280px !important;
        }

        .custom-popup .leaflet-popup-tip-container {
            margin-top: -1px;
        }

        .status-waiting {
            background-color: #FEF3C7;
            color: #92400E;
        }

        .status-processing {
            background-color: #DBEAFE;
            color: #1E40AF;
        }

        .status-completed {
            background-color: #D1FAE5;
            color: #065F46;
        }

        .marker-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border: 3px solid;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <header class="bg-emerald-600 text-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <img src="logo.png" width="10%">
                    <h1 class="text-xl font-bold">GreenKu</h1>
                </div>

                <!-- Centered Mode Buttons -->
                <div class="flex justify-center items-center space-x-4">
                    <button id="userModeBtn"
                        class="bg-white text-emerald-600 px-4 py-2 rounded-full font-medium text-sm shadow-sm hover:bg-emerald-50 transition">Mode
                        Pengguna</button>
                    <button id="staffModeBtn"
                        class="bg-emerald-700 text-white px-4 py-2 rounded-full font-medium text-sm shadow-sm hover:bg-emerald-800 transition">Mode
                        Petugas</button>
                </div>

                <!-- Login/Register Buttons -->
                <div class="flex items-center space-x-3">
                    <button id="loginBtn"
                        class="bg-white text-emerald-600 px-4 py-2 rounded-lg font-medium text-sm shadow-sm hover:bg-emerald-50 transition">Login</button>
                    <button id="registerBtn"
                        class="bg-emerald-800 text-white px-4 py-2 rounded-lg font-medium text-sm shadow-sm hover:bg-emerald-900 transition">Register</button>
                </div>
            </div>
        </header>

        <!-- Login Modal -->
        <div id="loginModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex justify-center items-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Login</h2>
                    <button id="closeLoginModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="loginForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Email/Nomor Telepon</label>
                        <input type="text" name="email"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500"
                            required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Kata Sandi</label>
                        <input type="password" name="password"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500"
                            required>
                    </div>

                    <div class="mb-4">
                        <a href="#" class="text-emerald-600 text-sm hover:underline">Lupa Kata Sandi?</a>
                    </div>

                    <button type="submit"
                        class="w-full bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition">Masuk</button>
                </form>
            </div>
        </div>

        <!-- Register Modal -->
        <div id="registerModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex justify-center items-center">
            <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Register</h2>
                    <button id="closeRegisterModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="registerForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nama Lengkap</label>
                        <input type="text" name="name"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500"
                            required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                        <input type="email" name="email"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500"
                            required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nomor Telepon</label>
                        <input type="tel" name="phone"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500"
                            required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Kata Sandi</label>
                        <input type="password" name="password"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500"
                            required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Konfirmasi Kata Sandi</label>
                        <input type="password" name="password_confirmation"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-emerald-500"
                            required>
                    </div>

                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-2" required>
                            <span class="text-sm text-gray-600">Saya setuju dengan <a href="#"
                                    class="text-emerald-600 hover:underline">Syarat dan Ketentuan</a></span>
                        </label>
                    </div>

                    <button type="submit"
                        class="w-full bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition">Daftar</button>
                </form>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-grow flex flex-col md:flex-row relative">
            <!-- Desktop Sidebar (Hidden on mobile) -->
            <div id="sidebar" class="hidden md:block w-96 bg-white shadow-md p-4 overflow-y-auto">
                <!-- User Mode Content -->
                <div id="userModeContent" class="space-y-4">
                    <div class="bg-emerald-50 rounded-lg p-4">
                        <h2 class="font-semibold text-emerald-800 mb-2">Laporkan Sampah</h2>
                        <p class="text-sm text-gray-600 mb-3">Klik pada peta untuk menandai lokasi sampah atau gunakan
                            tombol di bawah untuk menggunakan lokasi Anda saat ini.</p>
                        <button id="useCurrentLocationBtn"
                            class="w-full bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Gunakan Lokasi Saat Ini
                        </button>
                    </div>

                    <div id="requestForm" class="hidden bg-white border border-gray-200 rounded-lg p-4 space-y-3">
                        <h3 class="font-semibold text-gray-800">Detail Permintaan</h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Sampah</label>
                            <select id="wasteType"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                <option value="organik">Organik</option>
                                <option value="anorganik">Anorganik</option>
                                <option value="b3">B3 (Berbahaya)</option>
                                <option value="elektronik">Elektronik</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Perkiraan Volume</label>
                            <select id="wasteVolume"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                <option value="kecil">Kecil (< 5kg)</option>
                                <option value="sedang">Sedang (5-20kg)</option>
                                <option value="besar">Besar (> 20kg)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                            <textarea id="description" rows="3"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                placeholder="Berikan detail tambahan..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kontak</label>
                            <input type="text" id="contact"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                placeholder="Nomor telepon">
                        </div>
                        <div class="flex space-x-2 pt-2">
                            <button id="cancelRequestBtn"
                                class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-200 transition">Batal</button>
                            <button id="submitRequestBtn"
                                class="flex-1 bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition">Kirim</button>
                        </div>
                    </div>

                    <div id="userRequestsList" class="space-y-3">
                        <h3 class="font-semibold text-gray-800">Permintaan Saya</h3>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <!-- User requests will be populated here -->
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-2">Bank Sampah Terdekat</h3>
                        <div id="nearbyRecyclingCenters" class="space-y-2">
                            <!-- Recycling centers will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Staff Mode Content -->
                <div id="staffModeContent" class="hidden space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h2 class="font-semibold text-blue-800 mb-2">Panel Petugas</h2>
                        <p class="text-sm text-gray-600">Selamat datang, Petugas. Berikut adalah daftar permintaan yang
                            perlu ditindaklanjuti.</p>
                    </div>

                    <div class="flex space-x-2 mb-3">
                        <button class="request-filter-btn flex-1 bg-emerald-600 text-white py-2 rounded-lg font-medium"
                            data-filter="all">Semua</button>
                        <button class="request-filter-btn flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-medium"
                            data-filter="waiting">Menunggu</button>
                        <button class="request-filter-btn flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-medium"
                            data-filter="processing">Diproses</button>
                        <button class="request-filter-btn flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-medium"
                            data-filter="rewards">
                            <div class="flex items-center justify-center space-x-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Rewards</span>
                            </div>
                        </button>
                    </div>

                    <div id="staffRequestsList" class="space-y-3">
                        <!-- Staff requests will be populated here -->
                    </div>

                    <div id="requestDetail" class="hidden border border-gray-200 rounded-lg p-4 space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="font-semibold text-gray-800">Detail Permintaan</h3>
                            <button id="closeDetailBtn" class="text-gray-500 hover:text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div id="requestDetailContent">
                            <!-- Request details will be populated here -->
                        </div>
                        <div class="flex space-x-2 pt-2" id="requestActionButtons">
                            <!-- Action buttons will be populated here based on request status -->
                        </div>
                    </div>

                    <!-- Rewards Tab Content (Hidden by default) -->
                    <div id="rewardsTab" class="tab-content hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Program Rewards</h2>

                        <div class="bg-green-50 rounded-xl p-4 mb-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-medium text-gray-800">Poin Anda</h3>
                                    <p class="text-green-600 font-bold text-2xl">325</p>
                                </div>
                                <button class="bg-green-600 text-white text-sm font-medium px-4 py-2 rounded-lg">Tukar
                                    Poin</button>
                            </div>
                        </div>

                        <h3 class="font-medium text-gray-800 mb-3">Reward Tersedia</h3>

                        <div class="space-y-4">
                            <div class="bg-white rounded-xl shadow-sm p-4 flex">
                                <div class="bg-blue-100 rounded-lg h-16 w-16 flex items-center justify-center mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-medium text-gray-800">Voucher Belanja</h4>
                                        <span
                                            class="bg-blue-100 text-blue-600 text-xs font-medium px-2.5 py-0.5 rounded-full">200
                                            poin</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2">Diskon Rp25.000 di Supermarket Lokal</p>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-blue-600 h-1.5 rounded-full" style="width: 75%"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>Tersisa 15 voucher</span>
                                        <span>Berakhir dalam 5 hari</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm p-4 flex">
                                <div class="bg-purple-100 rounded-lg h-16 w-16 flex items-center justify-center mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-medium text-gray-800">Token Listrik</h4>
                                        <span
                                            class="bg-purple-100 text-purple-600 text-xs font-medium px-2.5 py-0.5 rounded-full">350
                                            poin</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2">Token PLN senilai Rp50.000</p>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-purple-600 h-1.5 rounded-full" style="width: 40%"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>Tersisa 8 voucher</span>
                                        <span>Berakhir dalam 12 hari</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm p-4 flex">
                                <div class="bg-yellow-100 rounded-lg h-16 w-16 flex items-center justify-center mr-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-medium text-gray-800">Cashback e-Wallet</h4>
                                        <span
                                            class="bg-yellow-100 text-yellow-600 text-xs font-medium px-2.5 py-0.5 rounded-full">500
                                            poin</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2">Rp75.000 ke e-Wallet pilihan</p>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-yellow-600 h-1.5 rounded-full" style="width: 60%"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>Tersisa 5 voucher</span>
                                        <span>Berakhir dalam 7 hari</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Bottom Panel (Hidden on desktop) -->
            <div id="bottomPanel"
                class="md:hidden fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl z-[100] transition-transform duration-300 ease-out transform translate-y-[calc(100%-120px)]">
                <!-- Panel Handle -->
                <div class="w-full flex justify-center pt-3 pb-2">
                    <div id="panelHandle"
                        class="w-16 h-1.5 bg-gray-300 rounded-full cursor-pointer hover:bg-gray-400 transition-colors">
                    </div>
                </div>

                <!-- Panel Header -->
                <div class="px-5 pb-3 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-800 text-lg">GreenKu Panel</h3>
                        <button id="panelCollapseBtn"
                            class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 transform transition-transform duration-200" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Panel Content -->
                <div id="panelContent" class="overflow-y-auto max-h-[calc(100vh-200px)] px-5 py-4">
                    <!-- User Mode Content for Mobile -->
                    <div id="userModeContentMobile" class="space-y-4">
                        <div class="bg-emerald-50 rounded-lg p-4">
                            <h2 class="font-semibold text-emerald-800 mb-2">Laporkan Sampah</h2>
                            <p class="text-sm text-gray-600 mb-3">Klik pada peta untuk menandai lokasi sampah atau
                                gunakan
                                tombol di bawah untuk menggunakan lokasi Anda saat ini.</p>
                            <button id="useCurrentLocationBtnMobile"
                                class="w-full bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Gunakan Lokasi Saat Ini
                            </button>
                        </div>

                        <div id="requestFormMobile"
                            class="hidden bg-white border border-gray-200 rounded-lg p-4 space-y-3">
                            <h3 class="font-semibold text-gray-800">Detail Permintaan</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Sampah</label>
                                <select id="wasteTypeMobile"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                    <option value="organik">Organik</option>
                                    <option value="anorganik">Anorganik</option>
                                    <option value="b3">B3 (Berbahaya)</option>
                                    <option value="elektronik">Elektronik</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Perkiraan Volume</label>
                                <select id="wasteVolumeMobile"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                    <option value="kecil">Kecil (< 5kg)</option>
                                    <option value="sedang">Sedang (5-20kg)</option>
                                    <option value="besar">Besar (> 20kg)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                                <textarea id="descriptionMobile" rows="3"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    placeholder="Berikan detail tambahan..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kontak</label>
                                <input type="text" id="contactMobile"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    placeholder="Nomor telepon">
                            </div>
                            <div class="flex space-x-2 pt-2">
                                <button id="cancelRequestBtnMobile"
                                    class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-200 transition">Batal</button>
                                <button id="submitRequestBtnMobile"
                                    class="flex-1 bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition">Kirim</button>
                            </div>
                        </div>

                        <div id="userRequestsListMobile" class="space-y-3">
                            <h3 class="font-semibold text-gray-800">Permintaan Saya</h3>
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <!-- User requests will be populated here -->
                            </div>
                        </div>

                        <div class="bg-blue-50 rounded-lg p-4">
                            <h3 class="font-semibold text-blue-800 mb-2">Bank Sampah Terdekat</h3>
                            <div id="nearbyRecyclingCentersMobile" class="space-y-2">
                                <!-- Recycling centers will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Staff Mode Content for Mobile -->
                    <div id="staffModeContentMobile" class="hidden space-y-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h2 class="font-semibold text-blue-800 mb-2">Panel Petugas</h2>
                            <p class="text-sm text-gray-600">Selamat datang, Petugas. Berikut adalah daftar permintaan
                                yang
                                perlu ditindaklanjuti.</p>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <button
                                class="request-filter-btn-mobile bg-emerald-600 text-white py-2 rounded-lg font-medium text-sm"
                                data-filter="all">Semua</button>
                            <button
                                class="request-filter-btn-mobile bg-gray-200 text-gray-700 py-2 rounded-lg font-medium text-sm"
                                data-filter="waiting">Menunggu</button>
                            <button
                                class="request-filter-btn-mobile bg-gray-200 text-gray-700 py-2 rounded-lg font-medium text-sm"
                                data-filter="processing">Diproses</button>
                            <button
                                class="request-filter-btn-mobile bg-gray-200 text-gray-700 py-2 rounded-lg font-medium text-sm"
                                data-filter="rewards">
                                <div class="flex items-center justify-center space-x-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span>Rewards</span>
                                </div>
                            </button>
                        </div>

                        <div id="staffRequestsListMobile" class="space-y-3">
                            <!-- Staff requests will be populated here -->
                        </div>

                        <div id="requestDetailMobile" class="hidden border border-gray-200 rounded-lg p-4 space-y-3">
                            <div class="flex justify-between items-center">
                                <h3 class="font-semibold text-gray-800">Detail Permintaan</h3>
                                <button id="closeDetailBtnMobile" class="text-gray-500 hover:text-gray-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <div id="requestDetailContentMobile">
                                <!-- Request details will be populated here -->
                            </div>
                            <div class="flex space-x-2 pt-2" id="requestActionButtonsMobile">
                                <!-- Action buttons will be populated here based on request status -->
                            </div>
                        </div>

                        <!-- Rewards Tab Content for Mobile -->
                        <div id="rewardsTabMobile" class="tab-content hidden">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Program Rewards</h2>

                            <div class="bg-green-50 rounded-xl p-4 mb-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h3 class="font-medium text-gray-800">Poin Anda</h3>
                                        <p class="text-green-600 font-bold text-2xl">325</p>
                                    </div>
                                    <button
                                        class="bg-green-600 text-white text-sm font-medium px-4 py-2 rounded-lg">Tukar
                                        Poin</button>
                                </div>
                            </div>

                            <h3 class="font-medium text-gray-800 mb-3">Reward Tersedia</h3>

                            <div class="space-y-4">
                                <div class="bg-white rounded-xl shadow-sm p-4 flex">
                                    <div class="bg-blue-100 rounded-lg h-16 w-16 flex items-center justify-center mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-medium text-gray-800">Voucher Belanja</h4>
                                            <span
                                                class="bg-blue-100 text-blue-600 text-xs font-medium px-2.5 py-0.5 rounded-full">200
                                                poin</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-2">Diskon Rp25.000 di Supermarket Lokal</p>
                                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                                            <div class="bg-blue-600 h-1.5 rounded-full" style="width: 75%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>Tersisa 15 voucher</span>
                                            <span>Berakhir dalam 5 hari</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow-sm p-4 flex">
                                    <div
                                        class="bg-purple-100 rounded-lg h-16 w-16 flex items-center justify-center mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-medium text-gray-800">Token Listrik</h4>
                                            <span
                                                class="bg-purple-100 text-purple-600 text-xs font-medium px-2.5 py-0.5 rounded-full">350
                                                poin</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-2">Token PLN senilai Rp50.000</p>
                                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                                            <div class="bg-purple-600 h-1.5 rounded-full" style="width: 40%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>Tersisa 8 voucher</span>
                                            <span>Berakhir dalam 12 hari</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow-sm p-4 flex">
                                    <div
                                        class="bg-yellow-100 rounded-lg h-16 w-16 flex items-center justify-center mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-medium text-gray-800">Cashback e-Wallet</h4>
                                            <span
                                                class="bg-yellow-100 text-yellow-600 text-xs font-medium px-2.5 py-0.5 rounded-full">500
                                                poin</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-2">Rp75.000 ke e-Wallet pilihan</p>
                                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                                            <div class="bg-yellow-600 h-1.5 rounded-full" style="width: 60%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>Tersisa 5 voucher</span>
                                            <span>Berakhir dalam 7 hari</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="flex-grow p-4 md:p-4">
                <div class="h-full relative rounded-lg overflow-hidden shadow-md">
                    <div id="map"></div>
                    <div class="absolute bottom-4 right-4 z-[1000] flex flex-col space-y-2">
                        <button id="zoomInBtn"
                            class="bg-white w-10 h-10 rounded-full shadow-md flex items-center justify-center hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </button>
                        <button id="zoomOutBtn"
                            class="bg-white w-10 h-10 rounded-full shadow-md flex items-center justify-center hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                            </svg>
                        </button>
                        <button id="recenterBtn"
                            class="bg-white w-10 h-10 rounded-full shadow-md flex items-center justify-center hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Bottom Panel Drag Functionality (Mobile Only)
            document.addEventListener('DOMContentLoaded', function () {
                const bottomPanel = document.getElementById('bottomPanel');
                const panelHandle = document.getElementById('panelHandle');
                const panelCollapseBtn = document.getElementById('panelCollapseBtn');
                const panelContent = document.getElementById('panelContent');

                let isDragging = false;
                let startY = 0;
                let startTranslateY = 0;
                let isExpanded = false;

                // Panel positions
                const collapsedPosition = 'calc(100% - 120px)'; // Show only header
                const expandedPosition = '20px'; // Almost full screen

                // Touch/Mouse events for drag functionality
                function handleStart(e) {
                    isDragging = true;
                    startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

                    // Get current transform value
                    const transform = getComputedStyle(bottomPanel).transform;
                    if (transform !== 'none') {
                        const matrix = new DOMMatrix(transform);
                        startTranslateY = matrix.m42; // translateY value
                    } else {
                        startTranslateY = 0;
                    }

                    bottomPanel.style.transition = 'none';
                }

                function handleMove(e) {
                    if (!isDragging) return;

                    e.preventDefault();
                    const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                    const deltaY = currentY - startY;
                    const newTranslateY = startTranslateY + deltaY;

                    // Constrain movement
                    const maxTranslate = window.innerHeight - 120; // Collapsed state
                    const minTranslate = 20; // Expanded state

                    const constrainedY = Math.max(minTranslate, Math.min(maxTranslate, newTranslateY));
                    bottomPanel.style.transform = `translateY(${constrainedY}px)`;
                }

                function handleEnd(e) {
                    if (!isDragging) return;
                    isDragging = false;

                    bottomPanel.style.transition = 'transform 0.3s ease-out';

                    // Determine final position based on drag distance and velocity
                    const currentY = e.type === 'touchend' ? e.changedTouches[0].clientY : e.clientY;
                    const deltaY = currentY - startY;
                    const threshold = window.innerHeight * 0.3; // 30% of screen height

                    if (deltaY > threshold || (deltaY > 50 && !isExpanded)) {
                        // Collapse panel
                        collapsePanel();
                    } else if (deltaY < -threshold || (deltaY < -50 && isExpanded)) {
                        // Expand panel
                        expandPanel();
                    } else {
                        // Return to previous state
                        if (isExpanded) {
                            expandPanel();
                        } else {
                            collapsePanel();
                        }
                    }
                }

                function expandPanel() {
                    isExpanded = true;
                    bottomPanel.style.transform = `translateY(${expandedPosition})`;
                    panelCollapseBtn.querySelector('svg').style.transform = 'rotate(180deg)';
                    panelContent.style.maxHeight = `calc(100vh - 200px)`;
                }

                function collapsePanel() {
                    isExpanded = false;
                    bottomPanel.style.transform = `translateY(${collapsedPosition})`;
                    panelCollapseBtn.querySelector('svg').style.transform = 'rotate(0deg)';
                    panelContent.style.maxHeight = '0px';
                }

                // Handle tap/click events
                panelHandle.addEventListener('click', function () {
                    if (isExpanded) {
                        collapsePanel();
                    } else {
                        expandPanel();
                    }
                });

                panelCollapseBtn.addEventListener('click', function () {
                    if (isExpanded) {
                        collapsePanel();
                    } else {
                        expandPanel();
                    }
                });

                // Touch events
                panelHandle.addEventListener('touchstart', handleStart, { passive: false });
                document.addEventListener('touchmove', handleMove, { passive: false });
                document.addEventListener('touchend', handleEnd);

                // Mouse events (for testing on desktop)
                panelHandle.addEventListener('mousedown', handleStart);
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleEnd);

                // Prevent text selection during drag
                panelHandle.addEventListener('selectstart', function (e) {
                    e.preventDefault();
                });

                // Handle screen orientation change
                window.addEventListener('orientationchange', function () {
                    setTimeout(() => {
                        if (isExpanded) {
                            expandPanel();
                        } else {
                            collapsePanel();
                        }
                    }, 100);
                });
            });
        </script>

    </div>

    <!-- Notification Toast -->
    <div id="notificationToast"
        class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white shadow-lg rounded-lg px-4 py-3 hidden flex items-center space-x-3 z-50 transition-opacity duration-300">
        <div id="notificationIcon" class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center"></div>
        <div>
            <h4 id="notificationTitle" class="font-medium text-gray-900"></h4>
            <p id="notificationMessage" class="text-sm text-gray-600"></p>
        </div>
    </div>

    <script>
// GreenKu Samarinda - Aplikasi Pengelolaan Sampah Digital
(function() {
    'use strict';
    
    // Initialize variables
    let map = null;
    let userMarker = null;
    let tempMarker = null;
    let userPosition = null;
    let currentMode = 'user'; // 'user' or 'staff'
    let selectedRequestId = null;
    let isLoggedIn = false;

    // Sample data (koordinat Samarinda)
    const requests = [
        {
            id: 1,
            location: [-0.7893, 117.1218], // Samarinda coordinates
            type: 'anorganik',
            volume: 'sedang',
            description: 'Tumpukan sampah plastik di pinggir jalan',
            contact: '081234567890',
            status: 'waiting',
            timestamp: '2023-07-15T09:30:00',
            userId: 'user123'
        },
        {
            id: 2,
            location: [-0.7850, 117.1200],
            type: 'organik',
            volume: 'kecil',
            description: 'Sampah daun dan sisa makanan',
            contact: '081234567891',
            status: 'processing',
            timestamp: '2023-07-15T08:15:00',
            userId: 'user123',
            staffId: 'staff456',
            staffName: 'Budi Santoso'
        },
        {
            id: 3,
            location: [-0.7800, 117.1300],
            type: 'elektronik',
            volume: 'besar',
            description: 'Beberapa unit komputer bekas dan kabel',
            contact: '081234567892',
            status: 'completed',
            timestamp: '2023-07-14T14:20:00',
            userId: 'user456',
            staffId: 'staff456',
            staffName: 'Budi Santoso',
            completedAt: '2023-07-14T15:45:00'
        }
    ];

    const recyclingCenters = [
        {
            id: 1,
            name: 'Bank Sampah Mandiri Samarinda',
            location: [-0.7893, 117.1218],
            address: 'Jl. Kesuma Bangsa No. 15, Samarinda',
            types: ['organik', 'anorganik'],
            phone: '0541-5551234'
        },
        {
            id: 2,
            name: 'Pusat Daur Ulang Mahakam',
            location: [-0.7850, 117.1300],
            address: 'Jl. Mulawarman No. 45, Samarinda',
            types: ['anorganik', 'elektronik'],
            phone: '0541-5552345'
        },
        {
            id: 3,
            name: 'Bank Sampah Tepian',
            location: [-0.7800, 117.1200],
            address: 'Jl. Tepian No. 72, Samarinda',
            types: ['organik', 'anorganik', 'b3'],
            phone: '0541-5553456'
        }
    ];

    // Initialize map
    function initMap() {
        try {
            // Hapus map yang ada jika ada
            if (map) {
                map.remove();
                map = null;
            }

            // Koordinat Samarinda
            const samarinda = [-0.7893, 117.1218];
            map = L.map('map').setView(samarinda, 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add event listener for map clicks in user mode
            map.on('click', function (e) {
                if (currentMode === 'user') {
                    addTempMarker(e.latlng);
                }
            });

            // Load markers
            loadMarkers();
            
            console.log('Map initialized successfully');
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    // Load all markers on the map
    function loadMarkers() {
        // Add request markers
        requests.forEach(request => {
            addRequestMarker(request);
        });

        // Add recycling center markers
        recyclingCenters.forEach(center => {
            addRecyclingCenterMarker(center);
        });
    }

    // Add a temporary marker when user clicks on map
    function addTempMarker(latlng) {
        // Remove existing temp marker if any
        if (tempMarker) {
            map.removeLayer(tempMarker);
        }

        // Create new marker
        tempMarker = L.marker(latlng).addTo(map);

        // Show request form
        const requestForm = document.getElementById('requestForm');
        const requestFormMobile = document.getElementById('requestFormMobile');
        
        if (requestForm) {
            requestForm.classList.remove('hidden');
            requestForm.scrollIntoView({ behavior: 'smooth' });
        }
        
        if (requestFormMobile) {
            requestFormMobile.classList.remove('hidden');
        }
    }

    // Add a marker for waste collection request
    function addRequestMarker(request) {
        const { id, location, status, type } = request;

        // Create custom marker icon
        const markerHtml = `
            <div class="marker-icon" style="border-color: ${getStatusColor(status)}; background-color: ${getStatusColor(status)};">
                ${getWasteTypeIcon(type)}
            </div>
        `;

        const icon = L.divIcon({
            html: markerHtml,
            className: status === 'waiting' ? 'pulse' : '',
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });

        // Create marker
        const marker = L.marker(location, { icon }).addTo(map);

        // Add popup
        marker.bindPopup(createRequestPopup(request), {
            className: 'custom-popup',
            closeButton: false
        });

        // Add click event
        marker.on('click', function () {
            if (currentMode === 'staff') {
                showRequestDetail(id);
            }
        });
    }

    // Add a marker for recycling center
    function addRecyclingCenterMarker(center) {
        const { id, location, name } = center;

        // Create custom marker icon
        const markerHtml = `
            <div class="marker-icon" style="border-color: #3B82F6; background-color: #3B82F6;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </div>
        `;

        const icon = L.divIcon({
            html: markerHtml,
            className: '',
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });

        // Create marker
        const marker = L.marker(location, { icon }).addTo(map);

        // Add popup
        marker.bindPopup(createRecyclingCenterPopup(center), {
            className: 'custom-popup',
            closeButton: false
        });
    }

    // Create popup content for request
    function createRequestPopup(request) {
        const { id, type, volume, description, status, timestamp } = request;
        const date = new Date(timestamp);
        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

        return `
            <div class="p-0">
                <div class="status-${status} px-4 py-2 font-medium text-sm">
                    ${getStatusText(status)}
                </div>
                <div class="p-4">
                    <h3 class="font-medium text-gray-900">Permintaan #${id}</h3>
                    <div class="mt-2 space-y-1 text-sm">
                        <p><span class="font-medium">Jenis:</span> ${getWasteTypeName(type)}</p>
                        <p><span class="font-medium">Volume:</span> ${getVolumeName(volume)}</p>
                        <p><span class="font-medium">Waktu:</span> ${formattedDate}</p>
                        <p class="text-gray-600">${description}</p>
                    </div>
                    ${currentMode === 'staff' ? `
                    <button onclick="showRequestDetail(${id})" class="mt-3 w-full bg-blue-600 text-white py-1.5 rounded text-sm font-medium hover:bg-blue-700 transition">
                        Lihat Detail
                    </button>
                    ` : ''}
                </div>
            </div>
        `;
    }

    // Create popup content for recycling center
    function createRecyclingCenterPopup(center) {
        const { name, address, types, phone } = center;

        return `
            <div class="p-0">
                <div class="bg-blue-500 text-white px-4 py-2 font-medium text-sm">
                    Bank Sampah
                </div>
                <div class="p-4">
                    <h3 class="font-medium text-gray-900">${name}</h3>
                    <div class="mt-2 space-y-1 text-sm">
                        <p class="text-gray-600">${address}</p>
                        <p><span class="font-medium">Telepon:</span> ${phone}</p>
                        <p><span class="font-medium">Menerima:</span> ${types.map(t => getWasteTypeName(t)).join(', ')}</p>
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <button class="flex-1 bg-blue-600 text-white py-1.5 rounded text-sm font-medium hover:bg-blue-700 transition flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                            Hubungi
                        </button>
                        <button class="flex-1 bg-emerald-600 text-white py-1.5 rounded text-sm font-medium hover:bg-emerald-700 transition flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                            </svg>
                            Navigasi
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Mode switching function - PERBAIKAN UTAMA
    function switchMode(mode) {
        currentMode = mode;
        
        console.log('Switching to mode:', mode);
        
        const userModeBtn = document.getElementById('userModeBtn');
        const staffModeBtn = document.getElementById('staffModeBtn');
        
        // Update button styles
        if (userModeBtn && staffModeBtn) {
            if (mode === 'user') {
                // User mode active
                userModeBtn.classList.remove('bg-emerald-700', 'text-white');
                userModeBtn.classList.add('bg-white', 'text-emerald-600');
                staffModeBtn.classList.remove('bg-white', 'text-emerald-600');
                staffModeBtn.classList.add('bg-emerald-700', 'text-white');
            } else {
                // Staff mode active
                staffModeBtn.classList.remove('bg-emerald-700', 'text-white');
                staffModeBtn.classList.add('bg-white', 'text-emerald-600');
                userModeBtn.classList.remove('bg-white', 'text-emerald-600');
                userModeBtn.classList.add('bg-emerald-700', 'text-white');
            }
        }
        
        // Toggle content visibility - Desktop
        const userModeContent = document.getElementById('userModeContent');
        const staffModeContent = document.getElementById('staffModeContent');
        
        if (userModeContent && staffModeContent) {
            if (mode === 'user') {
                userModeContent.classList.remove('hidden');
                staffModeContent.classList.add('hidden');
            } else {
                staffModeContent.classList.remove('hidden');
                userModeContent.classList.add('hidden');
                updateStaffRequestsList();
            }
        }
        
        // Toggle content visibility - Mobile
        const userModeContentMobile = document.getElementById('userModeContentMobile');
        const staffModeContentMobile = document.getElementById('staffModeContentMobile');
        
        if (userModeContentMobile && staffModeContentMobile) {
            if (mode === 'user') {
                userModeContentMobile.classList.remove('hidden');
                staffModeContentMobile.classList.add('hidden');
            } else {
                staffModeContentMobile.classList.remove('hidden');
                userModeContentMobile.classList.add('hidden');
                updateStaffRequestsList();
            }
        }
        
        // Fix map display after mode switch
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
            }
        }, 100);
    }

    // Get user's current location
    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const { latitude, longitude } = position.coords;
                    userPosition = [latitude, longitude];

                    // Update user marker
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    // Create custom marker icon
                    const markerHtml = `
                        <div class="marker-icon" style="border-color: #4F46E5; background-color: #4F46E5;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                    `;

                    const icon = L.divIcon({
                        html: markerHtml,
                        className: '',
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    });

                    userMarker = L.marker(userPosition, { icon }).addTo(map);
                    userMarker.bindPopup('<div class="p-2 text-center"><strong>Lokasi Anda</strong></div>');

                    // Center map on user location
                    map.setView(userPosition, 15);

                    // If in user mode and using current location for request
                    if (currentMode === 'user' && tempMarker === null) {
                        addTempMarker(userPosition);
                    }

                    showNotification('success', 'Lokasi ditemukan', 'Peta telah diatur ke lokasi Anda saat ini.');
                },
                function (error) {
                    console.error('Error getting location:', error);
                    showNotification('error', 'Gagal mendapatkan lokasi', 'Pastikan Anda telah mengizinkan akses lokasi.');
                }
            );
        } else {
            showNotification('error', 'Geolokasi tidak didukung', 'Browser Anda tidak mendukung geolokasi.');
        }
    }

    // Submit a new request
    function submitRequest() {
        if (!tempMarker) {
            showNotification('error', 'Lokasi tidak ditemukan', 'Silakan pilih lokasi pada peta terlebih dahulu.');
            return;
        }

        const wasteType = document.getElementById('wasteType')?.value || document.getElementById('wasteTypeMobile')?.value || 'anorganik';
        const wasteVolume = document.getElementById('wasteVolume')?.value || document.getElementById('wasteVolumeMobile')?.value || 'sedang';
        const description = document.getElementById('description')?.value || document.getElementById('descriptionMobile')?.value || '';
        const contact = document.getElementById('contact')?.value || document.getElementById('contactMobile')?.value || '';

        if (!description || !contact) {
            showNotification('error', 'Data tidak lengkap', 'Silakan lengkapi semua data yang diperlukan.');
            return;
        }

        // Create new request
        const newRequest = {
            id: requests.length + 1,
            location: [tempMarker.getLatLng().lat, tempMarker.getLatLng().lng],
            type: wasteType,
            volume: wasteVolume,
            description: description,
            contact: contact,
            status: 'waiting',
            timestamp: new Date().toISOString(),
            userId: 'user123'
        };

        // Add to requests array
        requests.push(newRequest);

        // Add marker to map
        addRequestMarker(newRequest);

        // Reset form
        const requestForm = document.getElementById('requestForm');
        const requestFormMobile = document.getElementById('requestFormMobile');
        
        if (requestForm) requestForm.classList.add('hidden');
        if (requestFormMobile) requestFormMobile.classList.add('hidden');
        
        // Clear form fields
        ['description', 'contact', 'descriptionMobile', 'contactMobile'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });

        // Remove temp marker
        if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
        }

        // Update user requests list
        updateUserRequestsList();

        showNotification('success', 'Permintaan terkirim', 'Permintaan penjemputan sampah Anda telah berhasil dikirim.');
    }

    // Update the list of user requests
    function updateUserRequestsList() {
        const container = document.getElementById('userRequestsList');
        const containerMobile = document.getElementById('userRequestsListMobile');
        const userRequests = requests.filter(r => r.userId === 'user123');

        const generateRequestsHTML = () => {
            if (userRequests.length === 0) {
                return `
                    <h3 class="font-semibold text-gray-800">Permintaan Saya</h3>
                    <div class="text-center py-6 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <p>Anda belum memiliki permintaan penjemputan sampah.</p>
                    </div>
                `;
            }

            let html = `<h3 class="font-semibold text-gray-800">Permintaan Saya</h3>
                        <div class="border border-gray-200 rounded-lg overflow-hidden">`;

            userRequests.forEach(request => {
                const date = new Date(request.timestamp);
                const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

                html += `
                    <div class="border-b border-gray-200 last:border-b-0 hover:bg-gray-50">
                        <div class="p-3">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <span class="inline-block w-2 h-2 rounded-full bg-${getStatusDotColor(request.status)}"></span>
                                        <h4 class="font-medium text-gray-900">Permintaan #${request.id}</h4>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1">${getWasteTypeName(request.type)} - ${getVolumeName(request.volume)}</p>
                                </div>
                                <span class="text-xs text-gray-500">${formattedDate}</span>
                            </div>
                            <div class="mt-2">
                                <span class="inline-block px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(request.status)}">
                                    ${getStatusText(request.status)}
                                </span>
                            </div>
                            <button onclick="showRequestOnMap(${request.id})" class="mt-2 text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Lihat di Peta
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            return html;
        };

        const html = generateRequestsHTML();
        if (container) container.innerHTML = html;
        if (containerMobile) containerMobile.innerHTML = html;
    }

    // Update the list of staff requests
    function updateStaffRequestsList(filter = 'all') {
        const container = document.getElementById('staffRequestsList');
        const containerMobile = document.getElementById('staffRequestsListMobile');

        let filteredRequests = requests;
        if (filter !== 'all') {
            filteredRequests = requests.filter(r => r.status === filter);
        }

        const generateStaffRequestsHTML = () => {
            if (filteredRequests.length === 0) {
                return `
                    <div class="text-center py-6 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <p>Tidak ada permintaan ${filter === 'all' ? '' : getStatusText(filter)} saat ini.</p>
                    </div>
                `;
            }

            let html = '';

            filteredRequests.forEach(request => {
                const date = new Date(request.timestamp);
                const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

                html += `
                    <div class="border border-gray-200 rounded-lg overflow-hidden hover:bg-gray-50 cursor-pointer" onclick="showRequestDetail(${request.id})">
                        <div class="p-3">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <span class="inline-block w-2 h-2 rounded-full bg-${getStatusDotColor(request.status)}"></span>
                                        <h4 class="font-medium text-gray-900">Permintaan #${request.id}</h4>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1">${getWasteTypeName(request.type)} - ${getVolumeName(request.volume)}</p>
                                </div>
                                <span class="text-xs text-gray-500">${formattedDate}</span>
                            </div>
                            <div class="mt-2 flex justify-between items-center">
                                <span class="inline-block px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(request.status)}">
                                    ${getStatusText(request.status)}
                                </span>
                                <button class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                    Detail
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            return html;
        };

        const html = generateStaffRequestsHTML();
        if (container) container.innerHTML = html;
        if (containerMobile) containerMobile.innerHTML = html;
    }

    // Update the list of nearby recycling centers
    function updateRecyclingCentersList() {
        const container = document.getElementById('nearbyRecyclingCenters');
        const containerMobile = document.getElementById('nearbyRecyclingCentersMobile');

        const generateRecyclingCentersHTML = () => {
            let html = '';

            recyclingCenters.forEach(center => {
                html += `
                    <div class="bg-white border border-gray-200 rounded-lg p-3 hover:bg-blue-50 cursor-pointer" onclick="showRecyclingCenterOnMap(${center.id})">
                        <h4 class="font-medium text-gray-900">${center.name}</h4>
                        <p class="text-sm text-gray-600 mt-1">${center.address}</p>
                        <div class="mt-2 flex justify-between items-center">
                            <span class="text-xs text-gray-500">${center.types.map(t => getWasteTypeName(t)).join(', ')}</span>
                            <button class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Lihat di Peta
                            </button>
                        </div>
                    </div>
                `;
            });

            return html;
        };

        const html = generateRecyclingCentersHTML();
        if (container) container.innerHTML = html;
        if (containerMobile) containerMobile.innerHTML = html;
    }

    // Show request detail in staff mode
    function showRequestDetail(id) {
        selectedRequestId = id;
        const request = requests.find(r => r.id === id);

        if (!request) return;

        const detailContainer = document.getElementById('requestDetail');
        const detailContainerMobile = document.getElementById('requestDetailMobile');
        const detailContent = document.getElementById('requestDetailContent');
        const detailContentMobile = document.getElementById('requestDetailContentMobile');
        const actionButtons = document.getElementById('requestActionButtons');
        const actionButtonsMobile = document.getElementById('requestActionButtonsMobile');

        // Show detail container
        if (detailContainer) detailContainer.classList.remove('hidden');
        if (detailContainerMobile) detailContainerMobile.classList.remove('hidden');

        // Format date
        const date = new Date(request.timestamp);
        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

        // Populate detail content
        const detailHTML = `
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <h4 class="font-medium text-gray-900">Permintaan #${request.id}</h4>
                    <span class="inline-block px-2 py-1 text-xs rounded-full ${getStatusBadgeClass(request.status)}">
                        ${getStatusText(request.status)}
                    </span>
                </div>
                <div class="space-y-1 text-sm">
                    <p><span class="font-medium">Jenis Sampah:</span> ${getWasteTypeName(request.type)}</p>
                    <p><span class="font-medium">Volume:</span> ${getVolumeName(request.volume)}</p>
                    <p><span class="font-medium">Deskripsi:</span> ${request.description}</p>
                    <p><span class="font-medium">Kontak:</span> ${request.contact}</p>
                    <p><span class="font-medium">Waktu Permintaan:</span> ${formattedDate}</p>
                    ${request.status === 'processing' ? `<p><span class="font-medium">Diproses oleh:</span> ${request.staffName || 'Anda'}</p>` : ''}
                    ${request.status === 'completed' ? `
                        <p><span class="font-medium">Diselesaikan oleh:</span> ${request.staffName || 'Anda'}</p>
                        <p><span class="font-medium">Waktu Selesai:</span> ${new Date(request.completedAt).toLocaleString()}</p>
                    ` : ''}
                </div>
            </div>
        `;

        if (detailContent) detailContent.innerHTML = detailHTML;
        if (detailContentMobile) detailContentMobile.innerHTML = detailHTML;

        // Set action buttons based on status
        let actionButtonsHTML = '';
        if (request.status === 'waiting') {
            actionButtonsHTML = `
                <button onclick="processRequest(${request.id})" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    Proses Permintaan
                </button>
                <button onclick="showRequestOnMap(${request.id})" class="flex-1 bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    Navigasi
                </button>
            `;
        } else if (request.status === 'processing') {
            actionButtonsHTML = `
                <button onclick="completeRequest(${request.id})" class="flex-1 bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 transition flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Selesaikan
                </button>
                <button onclick="showRequestOnMap(${request.id})" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    Navigasi
                </button>
            `;
        } else {
            actionButtonsHTML = `
                <button onclick="showRequestOnMap(${request.id})" class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Lihat di Peta
                </button>
            `;
        }

        if (actionButtons) actionButtons.innerHTML = actionButtonsHTML;
        if (actionButtonsMobile) actionButtonsMobile.innerHTML = actionButtonsHTML;

        // Show request on map
        showRequestOnMap(id);
    }

    // Show request on map
    function showRequestOnMap(id) {
        const request = requests.find(r => r.id === id);

        if (!request) return;

        // Center map on request location
        map.setView(request.location, 16);

        // Find marker and open popup
        map.eachLayer(function (layer) {
            if (layer instanceof L.Marker) {
                const latlng = layer.getLatLng();
                if (Math.abs(latlng.lat - request.location[0]) < 0.0001 && Math.abs(latlng.lng - request.location[1]) < 0.0001) {
                    layer.openPopup();
                }
            }
        });
    }

    // Show recycling center on map
    function showRecyclingCenterOnMap(id) {
        const center = recyclingCenters.find(c => c.id === id);

        if (!center) return;

        // Center map on center location
        map.setView(center.location, 16);

        // Find marker and open popup
        map.eachLayer(function (layer) {
            if (layer instanceof L.Marker) {
                const latlng = layer.getLatLng();
                if (Math.abs(latlng.lat - center.location[0]) < 0.0001 && Math.abs(latlng.lng - center.location[1]) < 0.0001) {
                    layer.openPopup();
                }
            }
        });
    }

    // Process a request (staff)
    function processRequest(id) {
        const request = requests.find(r => r.id === id);

        if (!request) return;

        // Update request status
        request.status = 'processing';
        request.staffId = 'staff123';
        request.staffName = 'Anda';

        // Update marker
        map.eachLayer(function (layer) {
            if (layer instanceof L.Marker) {
                const latlng = layer.getLatLng();
                if (Math.abs(latlng.lat - request.location[0]) < 0.0001 && Math.abs(latlng.lng - request.location[1]) < 0.0001) {
                    map.removeLayer(layer);
                }
            }
        });

        addRequestMarker(request);

        // Update request detail
        showRequestDetail(id);

        // Update staff requests list
        updateStaffRequestsList();

        showNotification('success', 'Permintaan diproses', 'Anda telah mengambil tugas ini. Silakan menuju ke lokasi.');
    }

    // Complete a request (staff)
    function completeRequest(id) {
        const request = requests.find(r => r.id === id);

        if (!request) return;

        // Update request status
        request.status = 'completed';
        request.completedAt = new Date().toISOString();

        // Update marker
        map.eachLayer(function (layer) {
            if (layer instanceof L.Marker) {
                const latlng = layer.getLatLng();
                if (Math.abs(latlng.lat - request.location[0]) < 0.0001 && Math.abs(latlng.lng - request.location[1]) < 0.0001) {
                    map.removeLayer(layer);
                }
            }
        });

        addRequestMarker(request);

        // Update request detail
        showRequestDetail(id);

        // Update staff requests list
        updateStaffRequestsList();

        showNotification('success', 'Permintaan selesai', 'Terima kasih! Tugas telah berhasil diselesaikan.');
    }

    // Show notification toast
    function showNotification(type, title, message) {
        const toast = document.getElementById('notificationToast');
        const toastTitle = document.getElementById('notificationTitle');
        const toastMessage = document.getElementById('notificationMessage');
        const toastIcon = document.getElementById('notificationIcon');

        if (!toast) {
            console.log(`${type}: ${title} - ${message}`);
            return;
        }

        // Set content
        if (toastTitle) toastTitle.textContent = title;
        if (toastMessage) toastMessage.textContent = message;

        // Set icon and color based on type
        if (toastIcon) {
            if (type === 'success') {
                toastIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                `;
                toastIcon.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-emerald-500';
            } else if (type === 'error') {
                toastIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                `;
                toastIcon.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-red-500';
            }
        }

        // Show toast
        toast.classList.remove('hidden');
        toast.classList.add('flex');

        // Hide toast after 3 seconds
        setTimeout(function () {
            toast.classList.add('opacity-0');
            setTimeout(function () {
                toast.classList.remove('flex', 'opacity-0');
                toast.classList.add('hidden');
            }, 300);
        }, 3000);
    }

    // Helper functions
    function getStatusColor(status) {
        switch (status) {
            case 'waiting': return '#F59E0B';
            case 'processing': return '#3B82F6';
            case 'completed': return '#10B981';
            default: return '#6B7280';
        }
    }

    function getStatusDotColor(status) {
        switch (status) {
            case 'waiting': return 'amber-500';
            case 'processing': return 'blue-500';
            case 'completed': return 'emerald-500';
            default: return 'gray-500';
        }
    }

    function getStatusBadgeClass(status) {
        switch (status) {
            case 'waiting': return 'bg-amber-100 text-amber-800';
            case 'processing': return 'bg-blue-100 text-blue-800';
            case 'completed': return 'bg-emerald-100 text-emerald-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'waiting': return 'Menunggu';
            case 'processing': return 'Diproses';
            case 'completed': return 'Selesai';
            default: return 'Tidak diketahui';
        }
    }

    function getWasteTypeName(type) {
        switch (type) {
            case 'organik': return 'Sampah Organik';
            case 'anorganik': return 'Sampah Anorganik';
            case 'b3': return 'Sampah B3';
            case 'elektronik': return 'Sampah Elektronik';
            default: return 'Tidak diketahui';
        }
    }

    function getWasteTypeIcon(type) {
        switch (type) {
            case 'organik':
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>`;
            case 'anorganik':
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>`;
            case 'b3':
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>`;
            case 'elektronik':
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>`;
            default:
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>`;
        }
    }

    function getVolumeName(volume) {
        switch (volume) {
            case 'kecil': return 'Volume Kecil (< 5kg)';
            case 'sedang': return 'Volume Sedang (5-20kg)';
            case 'besar': return 'Volume Besar (> 20kg)';
            default: return 'Tidak diketahui';
        }
    }

    // Make functions available globally
    window.showRequestDetail = showRequestDetail;
    window.showRequestOnMap = showRequestOnMap;
    window.showRecyclingCenterOnMap = showRecyclingCenterOnMap;
    window.processRequest = processRequest;
    window.completeRequest = completeRequest;
    window.submitRequest = submitRequest;
    window.getUserLocation = getUserLocation;

    // Event listeners - GABUNGAN SEMUA DALAM SATU DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function () {
        console.log('GreenKu Samarinda: Initializing application...');
        
        // Initialize map
        initMap();

        // Initialize UI
        updateUserRequestsList();
        updateRecyclingCentersList();

        // ========== MODE SWITCHING - PERBAIKAN UTAMA ==========
        const userModeBtn = document.getElementById('userModeBtn');
        const staffModeBtn = document.getElementById('staffModeBtn');

        if (userModeBtn) {
            userModeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('User mode button clicked');
                switchMode('user');
            });
        }

        if (staffModeBtn) {
            staffModeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Staff mode button clicked');
                switchMode('staff');
            });
        }

        // ========== MAP CONTROLS ==========
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const recenterBtn = document.getElementById('recenterBtn');

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', function () {
                if (map) map.zoomIn();
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', function () {
                if (map) map.zoomOut();
            });
        }

        if (recenterBtn) {
            recenterBtn.addEventListener('click', function () {
                if (userPosition && map) {
                    map.setView(userPosition, 15);
                } else {
                    getUserLocation();
                }
            });
        }

        // ========== FORM CONTROLS ==========
        // Desktop form controls
        const useCurrentLocationBtn = document.getElementById('useCurrentLocationBtn');
        const submitRequestBtn = document.getElementById('submitRequestBtn');
        const cancelRequestBtn = document.getElementById('cancelRequestBtn');
        const closeDetailBtn = document.getElementById('closeDetailBtn');

        // Mobile form controls
        const useCurrentLocationBtnMobile = document.getElementById('useCurrentLocationBtnMobile');
        const submitRequestBtnMobile = document.getElementById('submitRequestBtnMobile');
        const cancelRequestBtnMobile = document.getElementById('cancelRequestBtnMobile');
        const closeDetailBtnMobile = document.getElementById('closeDetailBtnMobile');

        // Use current location buttons
        if (useCurrentLocationBtn) {
            useCurrentLocationBtn.addEventListener('click', getUserLocation);
        }
        if (useCurrentLocationBtnMobile) {
            useCurrentLocationBtnMobile.addEventListener('click', getUserLocation);
        }

        // Submit request buttons
        if (submitRequestBtn) {
            submitRequestBtn.addEventListener('click', submitRequest);
        }
        if (submitRequestBtnMobile) {
            submitRequestBtnMobile.addEventListener('click', submitRequest);
        }

        // Cancel request buttons
        if (cancelRequestBtn) {
            cancelRequestBtn.addEventListener('click', function () {
                const requestForm = document.getElementById('requestForm');
                if (requestForm) requestForm.classList.add('hidden');
                if (tempMarker && map) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
            });
        }
        if (cancelRequestBtnMobile) {
            cancelRequestBtnMobile.addEventListener('click', function () {
                const requestFormMobile = document.getElementById('requestFormMobile');
                if (requestFormMobile) requestFormMobile.classList.add('hidden');
                if (tempMarker && map) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
            });
        }

        // Close detail buttons
        if (closeDetailBtn) {
            closeDetailBtn.addEventListener('click', function () {
                const requestDetail = document.getElementById('requestDetail');
                if (requestDetail) requestDetail.classList.add('hidden');
                selectedRequestId = null;
            });
        }
        if (closeDetailBtnMobile) {
            closeDetailBtnMobile.addEventListener('click', function () {
                const requestDetailMobile = document.getElementById('requestDetailMobile');
                if (requestDetailMobile) requestDetailMobile.classList.add('hidden');
                selectedRequestId = null;
            });
        }

        // ========== FILTER BUTTONS - DESKTOP DAN MOBILE ==========
        const filterButtons = document.querySelectorAll('.request-filter-btn');
        const filterButtonsMobile = document.querySelectorAll('.request-filter-btn-mobile');
        const rewardsTab = document.getElementById('rewardsTab');
        const rewardsTabMobile = document.getElementById('rewardsTabMobile');

        // Desktop filter buttons
        filterButtons.forEach(button => {
            button.addEventListener('click', function () {
                const filter = this.getAttribute('data-filter');

                // Update active button
                filterButtons.forEach(btn => {
                    btn.classList.remove('bg-emerald-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                this.classList.remove('bg-gray-200', 'text-gray-700');
                this.classList.add('bg-emerald-600', 'text-white');

                // Handle rewards tab
                if (filter === 'rewards') {
                    if (rewardsTab) rewardsTab.classList.remove('hidden');
                } else {
                    if (rewardsTab) rewardsTab.classList.add('hidden');
                    updateStaffRequestsList(filter);
                }
            });
        });

        // Mobile filter buttons
        filterButtonsMobile.forEach(button => {
            button.addEventListener('click', function () {
                const filter = this.getAttribute('data-filter');

                // Update active button
                filterButtonsMobile.forEach(btn => {
                    btn.classList.remove('bg-emerald-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                this.classList.remove('bg-gray-200', 'text-gray-700');
                this.classList.add('bg-emerald-600', 'text-white');

                // Handle rewards tab
                if (filter === 'rewards') {
                    if (rewardsTabMobile) rewardsTabMobile.classList.remove('hidden');
                } else {
                    if (rewardsTabMobile) rewardsTabMobile.classList.add('hidden');
                    updateStaffRequestsList(filter);
                }
            });
        });

        // ========== RESPONSIVE FIXES ==========
        function fixMapDisplay() {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        }

        // Handle window resize
        window.addEventListener('resize', fixMapDisplay);
        window.addEventListener('orientationchange', fixMapDisplay);

        // Mobile specific fixes
        if (window.innerWidth <= 768) {
            setTimeout(fixMapDisplay, 1000);
        }

        // Set initial mode setelah semua UI elements ready
        setTimeout(() => {
            switchMode('user');
        }, 100);

        console.log('GreenKu Samarinda: Application initialized successfully!');
    });

})();
</script>

    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'949e7ae48022fd93',t:'MTc0ODk0NjI1OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>